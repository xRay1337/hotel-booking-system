# Техническое задание: Система бронирования отелей

## Архитектура приложения

Приложение должно состоять из следующих компонентов:

### Основные сервисы
- **API Gateway (Spring Cloud Gateway)** - шлюз для маршрутизации запросов, прокси-передача JWT в backend-сервисы, проверка доступа
- **Hotel Management Service** - управление отелями и номерами (CRUD), агрегации по загруженности
- **Booking Service** - создание бронирований и управление ими, интеграция с Hotel Service, регистрация и авторизация пользователей
- **Eureka Server** - сервер регистрации и динамического обнаружения сервисов

### Технические требования
- Каждый сервис - самостоятельное Spring Boot приложение
- In-memory база данных (H2) для каждого сервиса
- Java 17+
- Spring Boot 3.5.x
- Spring Cloud (совместимый релиз-трейн)

## Технологический стек

### Основные библиотеки
- Spring Data JPA + H2 (in-memory)
- Spring Security + JWT
- Spring Cloud Eureka (Service Discovery)
- Spring Cloud Gateway (API Gateway)
- Lombok, MapStruct (для DTO и маппинга)

## Функциональные требования

### Для пользователей
- Регистрация и вход (JWT)
- Просмотр доступных отелей и номеров
- Создание бронирования
- Просмотр своей истории бронирований

### Для администраторов
- CRUD-операции с отелями, номерами и пользователями
- Просмотр статистики загруженности номеров

## Бизнес-логика

### Алгоритм планирования занятости номеров
- Hotel Service ведёт статистику (количество бронирований номера)
- Booking Service при автоматическом подборе комнаты предлагает комнаты на основе агрегированных данных о бронированиях
- Сортировка доступных номеров по возрастанию `times_booked` (при равенстве - по идентификатору)

### Распределённая транзакция (Сага)
1. Booking Service создаёт бронирование в статусе `PENDING`
2. Вызывает Hotel Management Service для подтверждения доступности номера
3. При успешном ответе: `PENDING` → `CONFIRMED`
4. При ошибке/таймауте: `PENDING` → `CANCELLED` + компенсация

## Технические требования к реализации

### Идемпотентность и корреляция
- Использование корреляционного идентификатора (`requestId`)
- Сквозная корреляция действий через `bookingId`
- Защита от дублирования операций

### Безопасность данных
- Отсутствие гонок данных при конкурентных бронированиях
- Корректная обработка пересекающихся дат
- Возврат HTTP 409 при конфликтах

### Надёжность
- Тайм-ауты и retry-механизмы для межсервисных вызовов
- Circuit Breaker паттерн
- Компенсирующие действия при ошибках

## API Endpoints

### Gateway маршрутизация
- `/api/bookings/**` → Booking Service
- `/api/hotels/**` → Hotel Service

### Booking Service
| Метод | Endpoint | Роль | Описание |
|-------|----------|------|----------|
| POST | `/booking` | USER | Создание бронирования |
| GET | `/bookings` | USER | История бронирований |
| GET | `/booking/{id}` | USER | Получить бронирование по ID |
| DELETE | `/booking/{id}` | USER | Отменить бронирование |
| POST | `/user/register` | USER | Регистрация пользователя |
| POST | `/user/auth` | USER | Авторизация пользователя |
| DELETE | `/user` | ADMIN | Удалить пользователя |
| POST | `/user` | ADMIN | Создать пользователя |
| PATCH | `/user` | ADMIN | Обновить данные пользователя |

### Hotel Management Service
| Метод | Endpoint | Роль | Описание |
|-------|----------|------|----------|
| POST | `/api/hotels` | ADMIN | Добавить отель |
| POST | `/api/rooms` | ADMIN | Добавить номер |
| GET | `/api/hotels` | USER | Список отелей |
| GET | `/api/rooms/recommend` | USER | Рекомендованные номера |
| GET | `/api/rooms` | USER | Свободные номера |
| POST | `/api/rooms/{id}/confirm-availability` | INTERNAL | Подтвердить доступность |
| POST | `/api/rooms/{id}/release` | INTERNAL | Снять блокировку |

## Структура баз данных

### Booking Service
**Таблица `users`:**
- `id`, `username`, `password`, `role`

**Таблица `bookings`:**
- `id`, `user_id`, `room_id`, `start_date`, `end_date`, `status` (PENDING/CONFIRMED/CANCELLED), `created_at`

### Hotel Management Service
**Таблица `hotels`:**
- `id`, `name`, `address`

**Таблица `rooms`:**
- `id`, `hotel_id`, `number`, `available`, `times_booked`

## Требования к безопасности

- JWT-аутентификация (срок действия - 1 час)
- Разграничение ролей: USER, ADMIN
- Каждый сервис самостоятельно проверяет JWT (Resource Server)
- Gateway выполняет маршрутизацию и передачу токена

## Дополнительные требования

- Swagger/OpenAPI документация
- Тестирование (JUnit + MockMvc)
- Логирование ключевых событий
- Централизованная обработка ошибок

## Критерии оценивания

### Основные критерии (макс. 50 баллов)

1. **Алгоритм планирования занятости** (5 баллов)
2. **Согласованность данных между сервисами** (5 баллов)
3. **Booking Service** (5 баллов)
4. **Hotel Service** (5 баллов)
5. **Gateway + Eureka** (5 баллов)
6. **Безопасность** (5 баллов)
7. **Тестирование** (3 балла)
8. **Структура БД** (2 балла)
9. **Предзаполнение данных** (2 балла)
10. **Качество кода** (3 балла)
11. **Код-стиль** (2 балла)
12. **Обработка ошибок** (2 балла)
13. **Логирование** (2 балла)
14. **Документация** (2 балла)
15. **Поддерживаемость тестов** (2 балла)

**Минимальный проходной балл: 30**

## Этапы сдачи проекта

1. Размещение кода на GitHub
2. Добавление README.md с описанием:
    - Как пользоваться системой
    - Поддерживаемые эндпоинты
    - Инструкции по тестированию
3. Проверка соответствия ТЗ
4. Отправка ссылки на репозиторий

## Рекомендации по реализации

- Операции БД в локальных транзакциях (`@Transactional`)
- Отсутствие глобальных распределённых транзакций
- Идемпотентность всех операций
- Корреляция запросов через единые идентификаторы
- Защита от race condition
- Единый стиль кодирования